<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ä¼šå‘è´¢é›†å›¢</title>
  <style>
    body {
      font-family: "Microsoft YaHei", sans-serif;
      background: #f0f2f5;
      padding: 30px;
    }

    h2, h3 {
      margin-top: 20px;
      color: #333;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    th, td {
      border: 1px solid #eee;
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: #f7f8fa;
    }

    input {
      width: 100%;
      padding: 4px;
      box-sizing: border-box;
    }

    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }

    button {
      padding: 8px 16px;
      background-color: #1890ff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
      margin-right: 10px;
    }

    button:hover {
      background-color: #40a9ff;
    }

    pre {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
      white-space: pre-wrap;
    }

    ul {
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      list-style-type: disc;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<h2>ğŸ“‹ ç¾¤å‡ºå·æŠ¥è¡¨å·¥å…·</h2>

<table id="groupTable">
  <thead>
    <tr>
      <th>ç¾¤å</th>
      <th>å‡ºå·æ•°</th>
      <th>å•ä»·</th>
      <th>æ”¶å…¥ï¼ˆè‡ªåŠ¨ï¼‰</th>
      <th>å¤‡æ³¨</th>
      <th>æ“ä½œ</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<button onclick="addRow()">â• æ·»åŠ ç¾¤</button>

<h3>å‚æ•°è®¾ç½®</h3>
<label>çœŸæœº/åè®®æˆæœ¬ï¼š</label>
<input type="number" id="baseCost" value="2795">

<label>å·¥èµ„æ”¯å‡ºï¼š</label>
<input type="number" id="salaryCost" value="90">

<label>è¿”ç‚¹ç¾¤åï¼š</label>
<input type="text" id="rebateGroup" value="é˜¿å›½ç¾¤">

<label>è¿”ç‚¹æ¯”ä¾‹ï¼ˆä¾‹å¦‚ 0.15 è¡¨ç¤º 15%ï¼‰ï¼š</label>
<input type="number" step="0.01" id="rebateRate" value="0.15">

<br>
<button onclick="calculate()">ğŸ“Š è®¡ç®—æŠ¥è¡¨</button>
<button onclick="exportTXT()">ğŸ“¥ å¯¼å‡º TXT æŠ¥è¡¨</button>
<button onclick="exportHistory()">ğŸ“¤ å¯¼å‡ºå†å²</button>
<button onclick="clearHistory()">ğŸ—‘ï¸ æ¸…é™¤å†å²</button>

<h3>ğŸ“„ æŠ¥è¡¨é¢„è§ˆï¼š</h3>
<pre id="output">ï¼ˆç‚¹å‡»â€œè®¡ç®—æŠ¥è¡¨â€åæ˜¾ç¤ºï¼‰</pre>

<h3>ğŸ“ˆ å†å²åˆ©æ¶¦è®°å½•</h3>
<ul id="historyList"></ul>

<script>
  let latestReport = '';

  function addRow(group = '', count = '', price = '', remark = '') {
    const tbody = document.querySelector('#groupTable tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input value="${group}" class="groupName"></td>
      <td><input type="number" value="${count}" class="count" oninput="updateIncome(this)"></td>
      <td><input type="number" step="0.01" value="${price}" class="price" oninput="updateIncome(this)"></td>
      <td><input class="income" readonly></td>
      <td><input value="${remark}" class="remark"></td>
      <td><button onclick="this.closest('tr').remove()">åˆ é™¤</button></td>
    `;
    tbody.appendChild(tr);
    updateIncome(tr.querySelector('.count'));
  }

  function updateIncome(elem) {
    const row = elem.closest('tr');
    const count = parseFloat(row.querySelector('.count').value) || 0;
    const price = parseFloat(row.querySelector('.price').value) || 0;
    const income = count * price;
    row.querySelector('.income').value = income.toFixed(2);
  }

  function calculate() {
    const rows = document.querySelectorAll('#groupTable tbody tr');
    const rebateGroup = document.getElementById('rebateGroup').value.trim();
    const rebateRate = parseFloat(document.getElementById('rebateRate').value) || 0;
    const baseCost = parseFloat(document.getElementById('baseCost').value) || 0;
    const salaryCost = parseFloat(document.getElementById('salaryCost').value) || 0;

    let totalCount = 0;
    let totalIncome = 0;
    let rebateAmount = 0;
    let lines = [];

    rows.forEach(row => {
      const group = row.querySelector('.groupName').value.trim();
      const count = parseFloat(row.querySelector('.count').value) || 0;
      const price = parseFloat(row.querySelector('.price').value) || 0;
      const income = count * price;
      const remark = row.querySelector('.remark').value.trim();

      totalCount += count;
      totalIncome += income;

      let line = `${group.padEnd(8)} å‡ºå·æ•°: ${count}    å•ä»·: ${price}    æ”¶å…¥: ${income.toFixed(2)}`;
      if (remark) line += `    å¤‡æ³¨: ${remark}`;
      lines.push(line);

      if (group === rebateGroup) {
        rebateAmount = count * rebateRate;
      }
    });

    const totalCost = baseCost + salaryCost + rebateAmount;
    const profit = totalIncome - totalCost;
    const agentFee = profit * 0.1;
    const finalProfit = profit - agentFee;

    // æ¯è¡Œç©ºä¸€è¡Œ
    let output = `ğŸ“… ç¾¤å‘å·æ˜ç»†\n\n`;
    output += lines.map(line => line + '\n').join('\n');
    output += `\nğŸ“Œ åˆè®¡å‡ºå·æ•°ï¼š${totalCount} ä¸ª\n\n`;
    output += `ğŸ“Œ åˆè®¡æ”¶å…¥ï¼š${totalIncome.toFixed(2)} U\n\n`;
    output += `ä¸€ã€çœŸæœºåè®®æˆæœ¬ï¼š${baseCost.toFixed(2)} U\n\n`;
    output += `äºŒã€å·¥èµ„æ”¯å‡ºï¼š${salaryCost.toFixed(2)} U\n\n`;
    output += `ä¸‰ã€è¿”ç‚¹ï¼ˆ${rebateGroup}ï¼‰ï¼š${rebateAmount.toFixed(2)} U\n\n`;
    output += `å››ã€æ€»æ”¯å‡ºï¼š${totalCost.toFixed(2)} U\n\n`;
    output += `äº”ã€åˆ©æ¶¦ï¼š${totalIncome.toFixed(2)} - ${totalCost.toFixed(2)} = ${profit.toFixed(2)} U\n\n`;
    output += `å…­ã€ä»£ç†ææˆï¼ˆ10%ï¼‰ï¼š${agentFee.toFixed(2)} U\n\n`;
    output += `âœ… æœ€ç»ˆåˆ©æ¶¦ï¼š${finalProfit.toFixed(2)} U\n`;

    document.getElementById('output').textContent = output;
    latestReport = output;

    // å†å²è®°å½•ï¼ˆä¿ç•™å½“æ—¥æœ€å¤§å€¼ï¼‰
    const today = new Date().toISOString().slice(0, 10);
    let history = JSON.parse(localStorage.getItem('profitHistory') || '[]');
    const currentProfit = parseFloat(finalProfit.toFixed(2));
    const index = history.findIndex(item => item.date === today);
    if (index >= 0) {
      const existing = parseFloat(history[index].profit);
      if (currentProfit > existing) {
        history[index].profit = currentProfit.toFixed(2);
      }
    } else {
      history.push({ date: today, profit: currentProfit.toFixed(2) });
    }
    localStorage.setItem('profitHistory', JSON.stringify(history));
    renderHistory();
  }

  function exportTXT() {
    if (!latestReport) {
      alert("è¯·å…ˆè®¡ç®—æŠ¥è¡¨");
      return;
    }
    const today = new Date().toISOString().split("T")[0];
    const blob = new Blob([latestReport], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `æŠ¥è¡¨-${today}.txt`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function renderHistory() {
    const list = document.getElementById('historyList');
    const history = JSON.parse(localStorage.getItem('profitHistory') || '[]');
    list.innerHTML = '';
    let total = 0;
    history.forEach(item => {
      total += parseFloat(item.profit);
      const li = document.createElement('li');
      li.textContent = `${item.date}ï¼š${item.profit} U`;
      list.appendChild(li);
    });

    if (history.length > 0) {
      const li = document.createElement('li');
      li.innerHTML = `<strong>ğŸ“Š æ€»åˆ©æ¶¦åˆè®¡ï¼š${total.toFixed(2)} U</strong>`;
      list.appendChild(li);
    }
  }

  function clearHistory() {
    if (confirm("ç¡®å®šæ¸…é™¤æ‰€æœ‰å†å²è®°å½•ï¼Ÿ")) {
      localStorage.removeItem('profitHistory');
      renderHistory();
    }
  }

  function exportHistory() {
    const history = JSON.parse(localStorage.getItem('profitHistory') || '[]');
    if (!history.length) {
      alert("æš‚æ— å†å²è®°å½•");
      return;
    }
    let total = 0;
    let text = `ğŸ“ˆ å†å²åˆ©æ¶¦è®°å½•\n\n`;
    history.forEach(item => {
      total += parseFloat(item.profit);
      text += `${item.date}ï¼š${item.profit} U\n\n`;
    });
    text += `ğŸ“Š æ€»åˆ©æ¶¦åˆè®¡ï¼š${total.toFixed(2)} U\n`;

    const today = new Date().toISOString().slice(0, 10);
    const blob = new Blob([text], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `å†å²åˆ©æ¶¦-${today}.txt`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // åˆå§‹åŒ–
  addRow('é˜¿å›½ç¾¤', 555, 1.1, 'è¿”ç‚¹ç¾¤');
  renderHistory();
</script>

</body>
</html>
