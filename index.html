<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>会发财集团</title>
  <style>
    body {
      font-family: "Microsoft YaHei", sans-serif;
      background: #f0f2f5;
      padding: 30px;
    }

    h2, h3 {
      margin-top: 20px;
      color: #333;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    th, td {
      border: 1px solid #eee;
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: #f7f8fa;
    }

    input {
      width: 100%;
      padding: 4px;
      box-sizing: border-box;
    }

    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }

    button {
      padding: 8px 16px;
      background-color: #1890ff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
      margin-right: 10px;
    }

    button:hover {
      background-color: #40a9ff;
    }

    pre {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
      white-space: pre-wrap;
    }

    ul {
      background: #fff;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      list-style-type: disc;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<h2>📋 群出号报表工具</h2>

<table id="groupTable">
  <thead>
    <tr>
      <th>群名</th>
      <th>出号数</th>
      <th>单价</th>
      <th>收入（自动）</th>
      <th>备注</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<button onclick="addRow()">➕ 添加群</button>

<h3>参数设置</h3>
<label>真机/协议成本：</label>
<input type="number" id="baseCost" value="2795">

<label>工资支出：</label>
<input type="number" id="salaryCost" value="90">

<label>返点群名：</label>
<input type="text" id="rebateGroup" value="阿国群">

<label>返点比例（例如 0.15 表示 15%）：</label>
<input type="number" step="0.01" id="rebateRate" value="0.15">

<br>
<button onclick="calculate()">📊 计算报表</button>
<button onclick="exportTXT()">📥 导出 TXT 报表</button>
<button onclick="exportHistory()">📤 导出历史</button>
<button onclick="clearHistory()">🗑️ 清除历史</button>

<h3>📄 报表预览：</h3>
<pre id="output">（点击“计算报表”后显示）</pre>

<h3>📈 历史利润记录</h3>
<ul id="historyList"></ul>

<script>
  let latestReport = '';

  function addRow(group = '', count = '', price = '', remark = '') {
    const tbody = document.querySelector('#groupTable tbody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input value="${group}" class="groupName"></td>
      <td><input type="number" value="${count}" class="count" oninput="updateIncome(this)"></td>
      <td><input type="number" step="0.01" value="${price}" class="price" oninput="updateIncome(this)"></td>
      <td><input class="income" readonly></td>
      <td><input value="${remark}" class="remark"></td>
      <td><button onclick="this.closest('tr').remove()">删除</button></td>
    `;
    tbody.appendChild(tr);
    updateIncome(tr.querySelector('.count'));
  }

  function updateIncome(elem) {
    const row = elem.closest('tr');
    const count = parseFloat(row.querySelector('.count').value) || 0;
    const price = parseFloat(row.querySelector('.price').value) || 0;
    const income = count * price;
    row.querySelector('.income').value = income.toFixed(2);
  }

  function calculate() {
    const rows = document.querySelectorAll('#groupTable tbody tr');
    const rebateGroup = document.getElementById('rebateGroup').value.trim();
    const rebateRate = parseFloat(document.getElementById('rebateRate').value) || 0;
    const baseCost = parseFloat(document.getElementById('baseCost').value) || 0;
    const salaryCost = parseFloat(document.getElementById('salaryCost').value) || 0;

    let totalCount = 0;
    let totalIncome = 0;
    let rebateAmount = 0;
    let lines = [];

    rows.forEach(row => {
      const group = row.querySelector('.groupName').value.trim();
      const count = parseFloat(row.querySelector('.count').value) || 0;
      const price = parseFloat(row.querySelector('.price').value) || 0;
      const income = count * price;
      const remark = row.querySelector('.remark').value.trim();

      totalCount += count;
      totalIncome += income;

      let line = `${group.padEnd(8)} 出号数: ${count}    单价: ${price}    收入: ${income.toFixed(2)}`;
      if (remark) line += `    备注: ${remark}`;
      lines.push(line);

      if (group === rebateGroup) {
        rebateAmount = count * rebateRate;
      }
    });

    const totalCost = baseCost + salaryCost + rebateAmount;
    const profit = totalIncome - totalCost;
    const agentFee = profit * 0.1;
    const finalProfit = profit - agentFee;

    // 每行空一行
    let output = `📅 群发号明细\n\n`;
    output += lines.map(line => line + '\n').join('\n');
    output += `\n📌 合计出号数：${totalCount} 个\n\n`;
    output += `📌 合计收入：${totalIncome.toFixed(2)} U\n\n`;
    output += `一、真机协议成本：${baseCost.toFixed(2)} U\n\n`;
    output += `二、工资支出：${salaryCost.toFixed(2)} U\n\n`;
    output += `三、返点（${rebateGroup}）：${rebateAmount.toFixed(2)} U\n\n`;
    output += `四、总支出：${totalCost.toFixed(2)} U\n\n`;
    output += `五、利润：${totalIncome.toFixed(2)} - ${totalCost.toFixed(2)} = ${profit.toFixed(2)} U\n\n`;
    output += `六、代理提成（10%）：${agentFee.toFixed(2)} U\n\n`;
    output += `✅ 最终利润：${finalProfit.toFixed(2)} U\n`;

    document.getElementById('output').textContent = output;
    latestReport = output;

    // 历史记录（保留当日最大值）
    const today = new Date().toISOString().slice(0, 10);
    let history = JSON.parse(localStorage.getItem('profitHistory') || '[]');
    const currentProfit = parseFloat(finalProfit.toFixed(2));
    const index = history.findIndex(item => item.date === today);
    if (index >= 0) {
      const existing = parseFloat(history[index].profit);
      if (currentProfit > existing) {
        history[index].profit = currentProfit.toFixed(2);
      }
    } else {
      history.push({ date: today, profit: currentProfit.toFixed(2) });
    }
    localStorage.setItem('profitHistory', JSON.stringify(history));
    renderHistory();
  }

  function exportTXT() {
    if (!latestReport) {
      alert("请先计算报表");
      return;
    }
    const today = new Date().toISOString().split("T")[0];
    const blob = new Blob([latestReport], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `报表-${today}.txt`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  function renderHistory() {
    const list = document.getElementById('historyList');
    const history = JSON.parse(localStorage.getItem('profitHistory') || '[]');
    list.innerHTML = '';
    let total = 0;
    history.forEach(item => {
      total += parseFloat(item.profit);
      const li = document.createElement('li');
      li.textContent = `${item.date}：${item.profit} U`;
      list.appendChild(li);
    });

    if (history.length > 0) {
      const li = document.createElement('li');
      li.innerHTML = `<strong>📊 总利润合计：${total.toFixed(2)} U</strong>`;
      list.appendChild(li);
    }
  }

  function clearHistory() {
    if (confirm("确定清除所有历史记录？")) {
      localStorage.removeItem('profitHistory');
      renderHistory();
    }
  }

  function exportHistory() {
    const history = JSON.parse(localStorage.getItem('profitHistory') || '[]');
    if (!history.length) {
      alert("暂无历史记录");
      return;
    }
    let total = 0;
    let text = `📈 历史利润记录\n\n`;
    history.forEach(item => {
      total += parseFloat(item.profit);
      text += `${item.date}：${item.profit} U\n\n`;
    });
    text += `📊 总利润合计：${total.toFixed(2)} U\n`;

    const today = new Date().toISOString().slice(0, 10);
    const blob = new Blob([text], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `历史利润-${today}.txt`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // 初始化
  addRow('阿国群', 555, 1.1, '返点群');
  renderHistory();
</script>

</body>
</html>
